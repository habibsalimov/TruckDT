from flask import Flask, request, jsonify, Response # type: ignore
from flask_cors import CORS # type: ignore
import cv2 # type: ignore
import numpy as np # type: ignore
import base64
import io
from PIL import Image # type: ignore
import os
from dotenv import load_dotenv # type: ignore
import logging
import traceback
from datetime import datetime
import time
import threading

# Kendi mod√ºllerimizi import ediyoruz
from utils.vehicle_detector import VehicleDetector
from utils.plate_reader import PlateReader
from database_utils.database import SupabaseDB

# Environment variables y√ºkle
load_dotenv()

# Flask uygulamasƒ±nƒ± olu≈ütur
app = Flask(__name__)
CORS(app)  # React frontend ile ileti≈üim i√ßin

# Global kamera deƒüi≈ükenleri
camera = None
camera_id = 1  # Varsayƒ±lan olarak kamera 1
camera_active = False
detection_active = False

# Son tespit sonucu i√ßin global deƒüi≈üken
last_detection_result = None

# Geli≈ümi≈ü logging ayarla
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('app.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# Ba≈ülangƒ±√ß loglarƒ±
logger.info("üöõ Ara√ß Kapƒ±sƒ± & Plaka Tespit Sistemi ba≈ülatƒ±lƒ±yor...")
logger.info(f"Python s√ºr√ºm√º: {os.sys.version}")
logger.info(f"√áalƒ±≈üma dizini: {os.getcwd()}")

# Sƒ±nƒ±flarƒ± ba≈ülat
try:
    logger.info("VehicleDetector ba≈ülatƒ±lƒ±yor...")
    detector = VehicleDetector()
    logger.info("‚úÖ VehicleDetector ba≈üarƒ±yla ba≈ülatƒ±ldƒ±")
except Exception as e:
    logger.error(f"‚ùå VehicleDetector ba≈ülatma hatasƒ±: {str(e)}")
    logger.error(traceback.format_exc())

try:
    logger.info("PlateReader ba≈ülatƒ±lƒ±yor...")
    plate_reader = PlateReader()
    logger.info("‚úÖ PlateReader ba≈üarƒ±yla ba≈ülatƒ±ldƒ±")
except Exception as e:
    logger.error(f"‚ùå PlateReader ba≈ülatma hatasƒ±: {str(e)}")
    logger.error(traceback.format_exc())

try:
    logger.info("SupabaseDB baƒülantƒ±sƒ± kuruluyor...")
    supabase_db = SupabaseDB()
    logger.info("‚úÖ SupabaseDB ba≈üarƒ±yla baƒülandƒ±")
    
    # Demo plakalarƒ± kur
    try:
        supabase_db.setup_demo_plates()
    except Exception as demo_error:
        logger.warning(f"‚ö†Ô∏è Demo plaka kurulumu ba≈üarƒ±sƒ±z: {str(demo_error)}")
        
except Exception as e:
    logger.error(f"‚ùå SupabaseDB baƒülantƒ± hatasƒ±: {str(e)}")
    logger.error(traceback.format_exc())
    supabase_db = None

def init_camera(cam_id=1):
    """Kamerayƒ± ba≈ülat"""
    global camera, camera_id, camera_active
    
    try:
        if camera is not None:
            camera.release()
        
        logger.info(f"üé• Kamera {cam_id} ba≈ülatƒ±lƒ±yor...")
        camera = cv2.VideoCapture(cam_id)
        
        if not camera.isOpened():
            logger.error(f"‚ùå Kamera {cam_id} a√ßƒ±lamadƒ±!")
            return False
        
        # Kamera ayarlarƒ±
        camera.set(cv2.CAP_PROP_FRAME_WIDTH, 1280)
        camera.set(cv2.CAP_PROP_FRAME_HEIGHT, 720)
        camera.set(cv2.CAP_PROP_FPS, 30)
        
        camera_id = cam_id
        camera_active = True
        
        # Ger√ßek ayarlarƒ± al
        width = int(camera.get(cv2.CAP_PROP_FRAME_WIDTH))
        height = int(camera.get(cv2.CAP_PROP_FRAME_HEIGHT))
        fps = int(camera.get(cv2.CAP_PROP_FPS))
        
        logger.info(f"‚úÖ Kamera {cam_id} ba≈ülatƒ±ldƒ±: {width}x{height} @ {fps}fps")
        return True
        
    except Exception as e:
        logger.error(f"‚ùå Kamera ba≈ülatma hatasƒ±: {str(e)}")
        camera_active = False
        return False

def generate_frames():
    """Video stream i√ßin frame √ºret"""
    global camera, detection_active
    
    if camera is None:
        return
    
    frame_count = 0
    fps_start_time = time.time()
    last_detection_time = 0  # Son tespit zamanƒ±
    detection_cooldown = 3.0  # 3 saniye bekleme s√ºresi
    
    while camera_active:
        try:
            success, frame = camera.read()
            if not success:
                logger.error("Kameradan frame okunamadƒ±")
                break
            
            frame_count += 1
            current_time = time.time()
            
            # Tespit aktif ise ara√ß tespiti yap
            if detection_active:
                detections = detector.detect_frame(frame)
                frame = detector.draw_detections(frame, detections)
                
                # Kararlƒ± kamyon tespiti varsa i≈üle
                stable_trucks = [d for d in detections if d.get('is_truck', False) and d.get('stability_count', 0) >= 3]
                
                # Cooldown kontrol√º - √ßok sƒ±k tespit yapmayƒ± √∂nle
                if stable_trucks and (current_time - last_detection_time) > detection_cooldown:
                    logger.info(f"üöõ {len(stable_trucks)} adet kararlƒ± kamyon/tƒ±r tespit edildi!")
                    
                    for truck in stable_trucks:
                        try:
                            # Plaka tespiti i√ßin ROI al
                            x1, y1, x2, y2 = truck['bbox']
                            
                            # ROI boyut kontrol√º
                            if x2 > x1 and y2 > y1:
                                roi = frame[y1:y2, x1:x2]
                                
                                # ROI boyutu yeterli mi kontrol et
                                if roi.shape[0] > 50 and roi.shape[1] > 50:
                                    # Plaka tespit et
                                    plate_result = plate_reader.read_plate(roi)
                                    
                                    if plate_result.get('detected', False) and plate_result.get('text'):
                                        plate_text = plate_result['text'].strip().upper()
                                        
                                        if len(plate_text) >= 5:  # Minimum plaka uzunluƒüu
                                            logger.info(f"üìã Plaka okundu: {plate_text}")
                                            
                                            # Veritabanƒ±nda kontrol et
                                            if supabase_db:
                                                try:
                                                    is_authorized = supabase_db.check_plate(plate_text)
                                                    
                                                    # Eri≈üim logunu kaydet
                                                    access_granted = is_authorized
                                                    gate_action = 'open' if is_authorized else 'denied'
                                                    
                                                    supabase_db.add_access_log(
                                                        plate_text,
                                                        truck['class_name'],
                                                        gate_action,
                                                        access_granted
                                                    )
                                                    
                                                    if is_authorized:
                                                        logger.info(f"‚úÖ Eri≈üim izni verildi: {plate_text}")
                                                        # Frame'e ba≈üarƒ± mesajƒ± ekle
                                                        cv2.putText(frame, f"ERISIM IZNI VERILDI: {plate_text}", 
                                                                   (10, frame.shape[0] - 60), 
                                                                   cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 3)
                                                    else:
                                                        logger.warning(f"‚ùå Eri≈üim reddedildi: {plate_text}")
                                                        # Frame'e ret mesajƒ± ekle
                                                        cv2.putText(frame, f"ERISIM REDDEDILDI: {plate_text}", 
                                                                   (10, frame.shape[0] - 60), 
                                                                   cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 3)
                                                    
                                                    # Son tespit sonucunu global deƒüi≈ükene kaydet
                                                    global last_detection_result
                                                    last_detection_result = {
                                                        'plate_text': plate_text,
                                                        'vehicle_type': truck['class_name'],
                                                        'gate_action': gate_action,
                                                        'is_authorized': is_authorized,
                                                        'timestamp': datetime.now().isoformat(),
                                                        'access_granted': access_granted
                                                    }
                                                    
                                                    # Son tespit zamanƒ±nƒ± g√ºncelle
                                                    last_detection_time = current_time
                                                    
                                                except Exception as db_error:
                                                    logger.error(f"Veritabanƒ± i≈ülem hatasƒ±: {str(db_error)}")
                                            else:
                                                logger.warning("Supabase baƒülantƒ±sƒ± yok, plaka kontrol edilemiyor")
                                        else:
                                            logger.debug(f"Plaka √ßok kƒ±sa: {plate_text}")
                                    else:
                                        logger.debug("Plaka okunamadƒ± veya bo≈ü")
                                else:
                                    logger.debug("ROI boyutu √ßok k√º√ß√ºk")
                            else:
                                logger.debug("Ge√ßersiz bounding box koordinatlarƒ±")
                                
                        except Exception as e:
                            logger.error(f"Plaka i≈üleme hatasƒ±: {str(e)}")
                
                # Genel tespit bilgisini frame'e ekle
                if detections:
                    total_vehicles = len(detections)
                    stable_vehicles = len([d for d in detections if d.get('stability_count', 0) >= 3])
                    
                    info_text = f"Arac: {total_vehicles} | Kararli: {stable_vehicles}"
                    cv2.putText(frame, info_text, (10, frame.shape[0] - 100), 
                               cv2.FONT_HERSHEY_SIMPLEX, 0.7, (255, 255, 255), 2)
            
            # FPS hesapla ve g√∂ster
            if frame_count % 30 == 0:  # Her 30 frame'de bir
                elapsed = current_time - fps_start_time
                fps = 30 / elapsed if elapsed > 0 else 0
                
                # FPS bilgisini frame'e ekle
                cv2.putText(frame, f"FPS: {fps:.1f}", (frame.shape[1] - 120, 30), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
                
                fps_start_time = current_time
            
            # Tespit durumu g√∂stergesi
            status_text = "GERCEK ZAMANLI TESPIT AKTIF" if detection_active else "TESPIT PASIF"
            status_color = (0, 255, 0) if detection_active else (0, 0, 255)
            cv2.putText(frame, status_text, (10, 60), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.8, status_color, 2)
            
            # Frame'i encode et
            ret, buffer = cv2.imencode('.jpg', frame, [cv2.IMWRITE_JPEG_QUALITY, 85])
            if not ret:
                continue
            
            frame_bytes = buffer.tobytes()
            
            # Multipart response
            yield (b'--frame\r\n'
                   b'Content-Type: image/jpeg\r\n\r\n' + frame_bytes + b'\r\n')
            
        except Exception as e:
            logger.error(f"Frame √ºretim hatasƒ±: {str(e)}")
            break

@app.route('/api/health', methods=['GET'])
def health_check():
    """API saƒülƒ±k kontrol√º"""
    logger.info("Saƒülƒ±k kontrol√º istendi")
    
    health_status = {
        'status': 'healthy',
        'message': 'Ara√ß Kapƒ±sƒ± API √ßalƒ±≈üƒ±yor',
        'timestamp': datetime.now().isoformat(),
        'components': {
            'vehicle_detector': 'ok' if 'detector' in globals() else 'error',
            'plate_reader': 'ok' if 'plate_reader' in globals() else 'error',
            'supabase_db': 'ok' if supabase_db is not None else 'error',
            'camera': 'active' if camera_active else 'inactive'
        },
        'camera_info': {
            'id': camera_id,
            'active': camera_active,
            'detection_active': detection_active
        }
    }
    
    logger.info(f"Saƒülƒ±k durumu: {health_status}")
    return jsonify(health_status)

@app.route('/api/camera/list', methods=['GET'])
def list_cameras():
    """Mevcut kameralarƒ± listele"""
    logger.info("üìπ Kamera listesi istendi")
    
    try:
        cameras = detector.list_available_cameras()
        return jsonify({
            'cameras': cameras,
            'current_camera': camera_id,
            'camera_active': camera_active
        })
    except Exception as e:
        logger.error(f"‚ùå Kamera listeleme hatasƒ±: {str(e)}")
        return jsonify({'error': 'Kamera listeleme ba≈üarƒ±sƒ±z'}), 500

@app.route('/api/camera/start', methods=['POST'])
def start_camera():
    """Kamerayƒ± ba≈ülat"""
    logger.info("üé• Kamera ba≈ülatma isteƒüi")
    
    try:
        data = request.get_json()
        cam_id = data.get('camera_id', 1)
        
        if init_camera(cam_id):
            return jsonify({
                'success': True,
                'message': f'Kamera {cam_id} ba≈ülatƒ±ldƒ±',
                'camera_id': cam_id
            })
        else:
            return jsonify({
                'success': False,
                'message': f'Kamera {cam_id} ba≈ülatƒ±lamadƒ±'
            }), 500
            
    except Exception as e:
        logger.error(f"‚ùå Kamera ba≈ülatma hatasƒ±: {str(e)}")
        return jsonify({'error': 'Kamera ba≈ülatma ba≈üarƒ±sƒ±z'}), 500

@app.route('/api/camera/stop', methods=['POST'])
def stop_camera():
    """Kamerayƒ± durdur"""
    global camera, camera_active, detection_active
    
    logger.info("üõë Kamera durdurma isteƒüi")
    
    try:
        camera_active = False
        detection_active = False
        
        if camera is not None:
            camera.release()
            camera = None
        
        return jsonify({
            'success': True,
            'message': 'Kamera durduruldu'
        })
        
    except Exception as e:
        logger.error(f"‚ùå Kamera durdurma hatasƒ±: {str(e)}")
        return jsonify({'error': 'Kamera durdurma ba≈üarƒ±sƒ±z'}), 500

@app.route('/api/camera/stream')
def camera_stream():
    """Kamera stream endpoint'i"""
    global camera_active
    
    if not camera_active:
        # Kamera aktif deƒüilse ba≈ülat
        if not init_camera(camera_id):
            return "Kamera ba≈ülatƒ±lamadƒ±", 500
    
    return Response(generate_frames(),
                   mimetype='multipart/x-mixed-replace; boundary=frame')

@app.route('/api/detection/start', methods=['POST'])
def start_detection():
    """Ger√ßek zamanlƒ± tespiti ba≈ülat"""
    global detection_active
    
    logger.info("üéØ Ger√ßek zamanlƒ± tespit ba≈ülatƒ±lƒ±yor")
    
    try:
        if not camera_active:
            return jsonify({
                'success': False,
                'message': '√ñnce kamerayƒ± ba≈ülatƒ±n'
            }), 400
        
        detection_active = True
        
        return jsonify({
            'success': True,
            'message': 'Ger√ßek zamanlƒ± tespit ba≈ülatƒ±ldƒ±'
        })
        
    except Exception as e:
        logger.error(f"‚ùå Tespit ba≈ülatma hatasƒ±: {str(e)}")
        return jsonify({'error': 'Tespit ba≈ülatma ba≈üarƒ±sƒ±z'}), 500

@app.route('/api/detection/stop', methods=['POST'])
def stop_detection():
    """Ger√ßek zamanlƒ± tespiti durdur"""
    global detection_active
    
    logger.info("üõë Ger√ßek zamanlƒ± tespit durdurma isteƒüi")
    
    try:
        detection_active = False
        
        return jsonify({
            'success': True,
            'message': 'Ger√ßek zamanlƒ± tespit durduruldu'
        })
        
    except Exception as e:
        logger.error(f"‚ùå Tespit durdurma hatasƒ±: {str(e)}")
        return jsonify({'error': 'Tespit durdurma ba≈üarƒ±sƒ±z'}), 500

@app.route('/api/detection/latest', methods=['GET'])
def get_latest_detection():
    """En son tespit sonucunu d√∂nd√ºr"""
    global last_detection_result
    
    if last_detection_result is None:
        return jsonify({
            'has_result': False,
            'message': 'Hen√ºz tespit yapƒ±lmadƒ±'
        })
    
    # Sonucu d√∂nd√ºr ve sƒ±fƒ±rla (bir kez g√∂ster)
    result = last_detection_result.copy()
    last_detection_result = None
    
    return jsonify({
        'has_result': True,
        'result': result
    })

@app.route('/api/plates', methods=['GET'])
def get_plates():
    """Kayƒ±tlƒ± plakalarƒ± getir"""
    logger.info("üìã Plaka listesi istendi")
    
    try:
        if not supabase_db:
            logger.error("‚ùå Supabase baƒülantƒ±sƒ± yok")
            return jsonify({'error': 'Veritabanƒ± baƒülantƒ±sƒ± yok'}), 500
            
        plates = supabase_db.get_all_plates()
        logger.info(f"üìã {len(plates)} plaka bulundu")
        return jsonify({'plates': plates})
    except Exception as e:
        logger.error(f"‚ùå Plaka getirme hatasƒ±: {str(e)}")
        logger.error(traceback.format_exc())
        return jsonify({'error': 'Plakalar getirilemedi', 'details': str(e)}), 500

@app.route('/api/plates', methods=['POST'])
def add_plate():
    """Yeni plaka ekle"""
    logger.info("‚ûï Yeni plaka ekleme isteƒüi")
    
    try:
        if not supabase_db:
            logger.error("‚ùå Supabase baƒülantƒ±sƒ± yok")
            return jsonify({'error': 'Veritabanƒ± baƒülantƒ±sƒ± yok'}), 500
            
        data = request.get_json()
        logger.info(f"üì• Gelen veri: {data}")
        
        if 'plate_number' not in data:
            logger.error("‚ùå Plaka numarasƒ± eksik")
            return jsonify({'error': 'Plaka numarasƒ± gerekli'}), 400
        
        plate_number = data['plate_number'].upper().strip()
        logger.info(f"üî§ ƒ∞≈ülenmi≈ü plaka: {plate_number}")
        
        # Plaka formatƒ±nƒ± kontrol et (basit kontrol)
        if len(plate_number) < 5:
            logger.error(f"‚ùå Ge√ßersiz plaka formatƒ±: {plate_number}")
            return jsonify({'error': 'Ge√ßersiz plaka formatƒ±'}), 400
        
        logger.info(f"üíæ Plaka veritabanƒ±na ekleniyor: {plate_number}")
        result = supabase_db.add_plate(plate_number)
        
        if result:
            logger.info(f"‚úÖ Plaka ba≈üarƒ±yla eklendi: {plate_number}")
            return jsonify({
                'success': True,
                'message': f'Plaka {plate_number} ba≈üarƒ±yla eklendi'
            })
        else:
            logger.error(f"‚ùå Plaka eklenemedi: {plate_number}")
            return jsonify({'error': 'Plaka eklenemedi (muhtemelen zaten mevcut)'}), 400
            
    except Exception as e:
        logger.error(f"‚ùå Plaka ekleme hatasƒ±: {str(e)}")
        logger.error(traceback.format_exc())
        return jsonify({'error': 'Plaka ekleme ba≈üarƒ±sƒ±z', 'details': str(e)}), 500

@app.route('/api/plates/<plate_id>', methods=['DELETE'])
def delete_plate(plate_id):
    """Plaka sil"""
    logger.info(f"üóëÔ∏è Plaka silme isteƒüi: {plate_id}")
    
    try:
        if not supabase_db:
            logger.error("‚ùå Supabase baƒülantƒ±sƒ± yok")
            return jsonify({'error': 'Veritabanƒ± baƒülantƒ±sƒ± yok'}), 500
            
        result = supabase_db.delete_plate(plate_id)
        
        if result:
            logger.info(f"‚úÖ Plaka ba≈üarƒ±yla silindi: {plate_id}")
            return jsonify({
                'success': True,
                'message': 'Plaka ba≈üarƒ±yla silindi'
            })
        else:
            logger.error(f"‚ùå Plaka silinemedi: {plate_id}")
            return jsonify({'error': 'Plaka silinemedi'}), 500
            
    except Exception as e:
        logger.error(f"‚ùå Plaka silme hatasƒ±: {str(e)}")
        logger.error(traceback.format_exc())
        return jsonify({'error': 'Plaka silme ba≈üarƒ±sƒ±z', 'details': str(e)}), 500

@app.route('/api/check-plate', methods=['POST'])
def check_plate():
    """Plaka kontrol√º yap"""
    logger.info("üîç Plaka kontrol isteƒüi")
    
    try:
        if not supabase_db:
            logger.error("‚ùå Supabase baƒülantƒ±sƒ± yok")
            return jsonify({'error': 'Veritabanƒ± baƒülantƒ±sƒ± yok'}), 500
            
        data = request.get_json()
        if 'plate_number' not in data:
            logger.error("‚ùå Plaka numarasƒ± eksik")
            return jsonify({'error': 'Plaka numarasƒ± gerekli'}), 400
        
        plate_number = data['plate_number'].upper().strip()
        logger.info(f"üîç Kontrol edilen plaka: {plate_number}")
        
        is_authorized = supabase_db.check_plate(plate_number)
        logger.info(f"üîê Plaka yetki durumu: {is_authorized}")
        
        return jsonify({
            'plate_number': plate_number,
            'authorized': is_authorized,
            'gate_action': 'open' if is_authorized else 'denied',
            'message': 'Yetkili ara√ß' if is_authorized else 'Yetkisiz ara√ß'
        })
        
    except Exception as e:
        logger.error(f"‚ùå Plaka kontrol hatasƒ±: {str(e)}")
        logger.error(traceback.format_exc())
        return jsonify({'error': 'Plaka kontrol√º ba≈üarƒ±sƒ±z', 'details': str(e)}), 500

if __name__ == '__main__':
    logger.info("üöÄ Flask sunucusu ba≈ülatƒ±lƒ±yor...")
    logger.info("üìç Backend: http://localhost:5001")
    logger.info("üìç Frontend: http://localhost:3000")
    logger.info("üìç API Docs: http://localhost:5001/api/health")
    
    # Geli≈ütirme modunda √ßalƒ±≈ütƒ±r
    app.run(debug=True, host='0.0.0.0', port=5001) 